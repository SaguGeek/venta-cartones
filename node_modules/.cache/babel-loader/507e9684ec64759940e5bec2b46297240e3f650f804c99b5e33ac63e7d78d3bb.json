{"ast":null,"code":"import { createElementVNode as _createElementVNode, openBlock as _openBlock, createElementBlock as _createElementBlock, toDisplayString as _toDisplayString, createTextVNode as _createTextVNode, createCommentVNode as _createCommentVNode, withModifiers as _withModifiers } from \"vue\";\nconst _hoisted_1 = {\n  class: \"space-y-4\"\n};\nconst _hoisted_2 = [\"disabled\"];\nconst _hoisted_3 = {\n  key: 0,\n  class: \"flex items-center\"\n};\nconst _hoisted_4 = {\n  key: 1\n};\nconst _hoisted_5 = {\n  key: 0,\n  class: \"text-red-600 text-sm\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_cache[4] || (_cache[4] = _createElementVNode(\"h2\", {\n    class: \"text-xl font-semibold text-gray-800 mb-4\"\n  }, \"Subir Cartones\", -1 /* HOISTED */)), _createElementVNode(\"form\", {\n    onSubmit: _cache[1] || (_cache[1] = _withModifiers((...args) => $options.uploadImages && $options.uploadImages(...args), [\"prevent\"])),\n    class: \"space-y-4\"\n  }, [_createElementVNode(\"div\", null, [_cache[2] || (_cache[2] = _createElementVNode(\"label\", {\n    for: \"files\",\n    class: \"block text-sm font-medium text-gray-700\"\n  }, \"Seleccionar Cartones (múltiples imágenes)\", -1 /* HOISTED */)), _createElementVNode(\"input\", {\n    type: \"file\",\n    id: \"files\",\n    multiple: \"\",\n    accept: \"image/*\",\n    onChange: _cache[0] || (_cache[0] = (...args) => $options.handleFileChange && $options.handleFileChange(...args)),\n    class: \"mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-300\"\n  }, null, 32 /* NEED_HYDRATION */)]), _createElementVNode(\"button\", {\n    type: \"submit\",\n    disabled: $data.uploading || !$data.files.length,\n    class: \"w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 flex items-center justify-center\"\n  }, [$data.uploading ? (_openBlock(), _createElementBlock(\"span\", _hoisted_3, [_cache[3] || (_cache[3] = _createElementVNode(\"svg\", {\n    class: \"animate-spin h-5 w-5 mr-2 text-white\",\n    viewBox: \"0 0 24 24\"\n  }, [_createElementVNode(\"circle\", {\n    class: \"opacity-25\",\n    cx: \"12\",\n    cy: \"12\",\n    r: \"10\",\n    stroke: \"currentColor\",\n    \"stroke-width\": \"4\"\n  }), _createElementVNode(\"path\", {\n    class: \"opacity-75\",\n    fill: \"currentColor\",\n    d: \"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n  })], -1 /* HOISTED */)), _createTextVNode(\" Subiendo... (\" + _toDisplayString($data.uploadedCount) + \"/\" + _toDisplayString($data.totalFiles) + \") \", 1 /* TEXT */)])) : (_openBlock(), _createElementBlock(\"span\", _hoisted_4, \"Subir Cartones\"))], 8 /* PROPS */, _hoisted_2), $data.uploadErrors.length ? (_openBlock(), _createElementBlock(\"p\", _hoisted_5, \" Errores: \" + _toDisplayString($data.uploadErrors.join(', ')), 1 /* TEXT */)) : _createCommentVNode(\"v-if\", true)], 32 /* NEED_HYDRATION */)]);\n}","map":{"version":3,"names":["class","key","_createElementBlock","_hoisted_1","_createElementVNode","onSubmit","_cache","_withModifiers","args","$options","uploadImages","for","type","id","multiple","accept","onChange","handleFileChange","disabled","$data","uploading","files","length","_hoisted_3","viewBox","cx","cy","r","stroke","fill","d","_createTextVNode","_toDisplayString","uploadedCount","totalFiles","_hoisted_4","_hoisted_2","uploadErrors","_hoisted_5","join","_createCommentVNode"],"sources":["D:\\Lotweb\\venta-cartones\\src\\components\\UploadCarton.vue"],"sourcesContent":["```vue\r\n<template>\r\n  <div class=\"space-y-4\">\r\n    <h2 class=\"text-xl font-semibold text-gray-800 mb-4\">Subir Cartones</h2>\r\n    <form @submit.prevent=\"uploadImages\" class=\"space-y-4\">\r\n      <div>\r\n        <label for=\"files\" class=\"block text-sm font-medium text-gray-700\">Seleccionar Cartones (múltiples imágenes)</label>\r\n        <input\r\n          type=\"file\"\r\n          id=\"files\"\r\n          multiple\r\n          accept=\"image/*\"\r\n          @change=\"handleFileChange\"\r\n          class=\"mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-300\"\r\n        />\r\n      </div>\r\n      <button\r\n        type=\"submit\"\r\n        :disabled=\"uploading || !files.length\"\r\n        class=\"w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 flex items-center justify-center\"\r\n      >\r\n        <span v-if=\"uploading\" class=\"flex items-center\">\r\n          <svg class=\"animate-spin h-5 w-5 mr-2 text-white\" viewBox=\"0 0 24 24\">\r\n            <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n            <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n          </svg>\r\n          Subiendo... ({{ uploadedCount }}/{{ totalFiles }})\r\n        </span>\r\n        <span v-else>Subir Cartones</span>\r\n      </button>\r\n      <p v-if=\"uploadErrors.length\" class=\"text-red-600 text-sm\">\r\n        Errores: {{ uploadErrors.join(', ') }}\r\n      </p>\r\n    </form>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { storage, db } from '../firebase';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\nimport { collection, query, where, getDocs } from 'firebase/firestore';\r\n\r\nexport default {\r\n  name: 'UploadCarton',\r\n  data() {\r\n    return {\r\n      files: [],\r\n      uploading: false,\r\n      uploadedCount: 0,\r\n      totalFiles: 0,\r\n      uploadErrors: []\r\n    };\r\n  },\r\n  methods: {\r\n    handleFileChange(event) {\r\n      this.files = Array.from(event.target.files);\r\n      this.uploadErrors = []; // Reiniciar errores al seleccionar nuevos archivos\r\n    },\r\n    async uploadImages() {\r\n      if (!this.files.length) return;\r\n\r\n      this.uploading = true;\r\n      this.totalFiles = this.files.length;\r\n      this.uploadedCount = 0;\r\n      this.uploadErrors = [];\r\n\r\n      try {\r\n        const serials = this.files.map(file => file.name.split('.')[0]);\r\n        const nonDuplicates = await this.checkDuplicates(serials);\r\n\r\n        if (nonDuplicates.length === 0) {\r\n          alert('No hay cartones nuevos para subir (todos son duplicados).');\r\n          this.uploading = false;\r\n          return;\r\n        }\r\n\r\n        // Procesar en lotes de 5 archivos\r\n        const batchSize = 5;\r\n        for (let i = 0; i < nonDuplicates.length; i += batchSize) {\r\n          const batch = nonDuplicates.slice(i, i + batchSize);\r\n          await Promise.all(batch.map(file => this.processFile(file)));\r\n        }\r\n\r\n        this.$emit('images-uploaded', this.successfulUploads);\r\n        alert('Subida completada. Algunos archivos podrían no haberse subido debido a errores.');\r\n        this.files = [];\r\n      } catch (error) {\r\n        console.error('Error general al subir imágenes:', error);\r\n        alert('Error general al subir imágenes: ' + error.message);\r\n      } finally {\r\n        this.uploading = false;\r\n      }\r\n    },\r\n    async processFile(file) {\r\n      try {\r\n        const serial = file.name.split('.')[0];\r\n        const storageRef = ref(storage, `cartones/${serial}_${Date.now()}.${file.name.split('.').pop()}`);\r\n        await uploadBytes(storageRef, file);\r\n        const imageUrl = await getDownloadURL(storageRef);\r\n        this.successfulUploads.push({ serial, imageUrl });\r\n        this.uploadedCount++;\r\n      } catch (error) {\r\n        console.error(`Error al subir ${file.name}:`, error);\r\n        this.uploadErrors.push(`Error con ${file.name}: ${error.message}`);\r\n      }\r\n    },\r\n    async checkDuplicates(serials) {\r\n      try {\r\n        const cartonesRef = collection(db, 'cartones');\r\n        const q = query(cartonesRef, where('serial', 'in', serials));\r\n        const querySnapshot = await getDocs(q);\r\n        const existingSerials = querySnapshot.docs.map(doc => doc.data().serial);\r\n        return this.files.filter(file => !existingSerials.includes(file.name.split('.')[0]));\r\n      } catch (error) {\r\n        console.error('Error al verificar duplicados:', error);\r\n        return [];\r\n      }\r\n    }\r\n  },\r\n  computed: {\r\n    successfulUploads() {\r\n      return [];\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n/* Tailwind maneja los estilos */\r\n</style>\r\n```"],"mappings":";;EAEOA,KAAK,EAAC;AAAW;mBAFxB;;EAAAC,GAAA;EAqB+BD,KAAK,EAAC;;;EArBrCC,GAAA;AAAA;;EAAAA,GAAA;EA8BoCD,KAAK,EAAC;;;uBA5BxCE,mBAAA,CAgCM,OAhCNC,UAgCM,G,0BA/BJC,mBAAA,CAAwE;IAApEJ,KAAK,EAAC;EAA0C,GAAC,gBAAc,sBACnEI,mBAAA,CA6BO;IA7BAC,QAAM,EAAAC,MAAA,QAAAA,MAAA,MAJjBC,cAAA,KAAAC,IAAA,KAI2BC,QAAA,CAAAC,YAAA,IAAAD,QAAA,CAAAC,YAAA,IAAAF,IAAA,CAAY;IAAER,KAAK,EAAC;MACzCI,mBAAA,CAUM,c,0BATJA,mBAAA,CAAoH;IAA7GO,GAAG,EAAC,OAAO;IAACX,KAAK,EAAC;KAA0C,2CAAyC,sBAC5GI,mBAAA,CAOE;IANAQ,IAAI,EAAC,MAAM;IACXC,EAAE,EAAC,OAAO;IACVC,QAAQ,EAAR,EAAQ;IACRC,MAAM,EAAC,SAAS;IACfC,QAAM,EAAAV,MAAA,QAAAA,MAAA,UAAAE,IAAA,KAAEC,QAAA,CAAAQ,gBAAA,IAAAR,QAAA,CAAAQ,gBAAA,IAAAT,IAAA,CAAgB;IACzBR,KAAK,EAAC;uCAGVI,mBAAA,CAaS;IAZPQ,IAAI,EAAC,QAAQ;IACZM,QAAQ,EAAEC,KAAA,CAAAC,SAAS,KAAKD,KAAA,CAAAE,KAAK,CAACC,MAAM;IACrCtB,KAAK,EAAC;MAEMmB,KAAA,CAAAC,SAAS,I,cAArBlB,mBAAA,CAMO,QANPqB,UAMO,G,0BALLnB,mBAAA,CAGM;IAHDJ,KAAK,EAAC,sCAAsC;IAACwB,OAAO,EAAC;MACxDpB,mBAAA,CAAkG;IAA1FJ,KAAK,EAAC,YAAY;IAACyB,EAAE,EAAC,IAAI;IAACC,EAAE,EAAC,IAAI;IAACC,CAAC,EAAC,IAAI;IAACC,MAAM,EAAC,cAAc;IAAC,cAAY,EAAC;MACrFxB,mBAAA,CAAwK;IAAlKJ,KAAK,EAAC,YAAY;IAAC6B,IAAI,EAAC,cAAc;IAACC,CAAC,EAAC;2BAxB3DC,gBAAA,CAyBgB,gBACO,GAAAC,gBAAA,CAAGb,KAAA,CAAAc,aAAa,IAAG,GAAC,GAAAD,gBAAA,CAAGb,KAAA,CAAAe,UAAU,IAAG,IACnD,gB,oBACAhC,mBAAA,CAAkC,QA5B1CiC,UAAA,EA4BqB,gBAAc,G,iBA5BnCC,UAAA,GA8BejB,KAAA,CAAAkB,YAAY,CAACf,MAAM,I,cAA5BpB,mBAAA,CAEI,KAFJoC,UAEI,EAFuD,YAChD,GAAAN,gBAAA,CAAGb,KAAA,CAAAkB,YAAY,CAACE,IAAI,0BA/BrCC,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}